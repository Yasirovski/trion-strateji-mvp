<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Trion Strateji</title>
  <meta name="viewport" content="width=1100">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #fff; }
    header { font-size: 2em; font-weight: bold; margin: 20px 0 10px 40px; }
    .center-buttons {
      display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;
    }
    .center-buttons button {
      font-size: 1em; padding: 9px 22px; border-radius: 8px;
      background: #f2f2f2; border: 1px solid #ccc; cursor: pointer;
      transition: background .18s;
    }
    .center-buttons button:hover { background: #d3e5ff; }
    .container {
      display: flex; justify-content: center; align-items: flex-start; gap: 32px;
      width: 100%; max-width: 1500px; margin: 0 auto;
    }
    .left, .right {
      width: 270px; min-height: 700px; background: #f9f9f9;
      border-radius: 8px; padding: 12px; box-shadow: 0 2px 10px #eee;
    }
    .middle {
      flex: 1; display: flex; flex-direction: column; align-items: center;
    }
    .gauge-area {
      width: 410px; margin: 28px auto 0 auto; background: #fff;
      padding: 8px 0 0 0; text-align: center;
    }
    .gauge-label { font-weight: bold; font-size: 1.13em; margin-bottom: 2px; color: #222; }
    .news-title { font-weight: bold; font-size: 1.12em; margin-bottom: 12px; margin-top: 5px; }
    .news-list { max-height: 680px; overflow-y: auto; font-size: 0.98em; line-height: 1.5; }
    .news-list a { color: #0a2885; text-decoration: none; }
    .news-list a:hover { text-decoration: underline; }
    @media (max-width: 1100px) {
      .container { flex-direction: column; align-items: stretch; }
      .left, .right, .middle { width: 100%; min-height: unset; }
      .gauge-area { width: 95vw; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>Trion Strateji</header>
  <div class="center-buttons">
    <button id="bistBtn">Borsa İstanbul</button>
    <button id="usBtn">Amerika B.</button>
    <button id="emtiaBtn">Emtialar</button>
  </div>
  <div class="container">
    <!-- SOLDA GRAFİK MODÜLÜ -->
    <div class="left">
      <div id="symbol-widget"></div>
    </div>
    <!-- ORTA GRAFİK VE GAUGE -->
    <div class="middle">
      <div id="tv-chart"></div>
      <div class="gauge-area">
        <div class="gauge-label" id="gauge-label">Endeks Gücü</div>
        <canvas id="myGauge" width="400" height="210"></canvas>
      </div>
    </div>
    <!-- SAĞDA HABERLER -->
    <div class="right">
      <div class="news-title">Finans Haberleri</div>
      <div class="news-list" id="news-list"></div>
    </div>
  </div>
  <!-- TradingView JS -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    // ---- 1. SOLDAKİ GRAFİK MODÜLÜ (Symbol Overview Widget) ----
    const widgets = {
      bist: {
        symbols: [["BIST 100", "BIST:XU100"], ["BIST 30", "BIST:XU030"], ["THYAO", "BIST:THYAO"], ["ASELS", "BIST:ASELS"]],
      },
      nasdaq: {
        symbols: [["NASDAQ 100", "NASDAQ:NDX"], ["Apple", "NASDAQ:AAPL"], ["Microsoft", "NASDAQ:MSFT"], ["Nvidia", "NASDAQ:NVDA"]],
      },
      emtia: {
        symbols: [["Altın", "TVC:GOLD"], ["Platin", "TVC:PLATINUM"], ["BTC/USD", "BINANCE:BTCUSDT"]],
      }
    };
    function loadSymbolWidget(type) {
      document.getElementById("symbol-widget").innerHTML = "";
      let script = document.createElement('script');
      script.type = "text/javascript";
      script.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
      script.async = true;
      script.innerHTML = JSON.stringify({
        symbols: widgets[type].symbols,
        width: "100%",
        height: "510",
        locale: "tr",
        colorTheme: "light",
        isTransparent: false,
        showVolume: true,
        showChart: true
      });
      document.getElementById("symbol-widget").appendChild(script);
    }

    // ---- 2. ORTA GRAFİK (Ana Grafik) ----
    function loadChart(symbol) {
      document.getElementById("tv-chart").innerHTML = "";
      let chartDiv = document.createElement('div');
      chartDiv.id = "tradingview_chart";
      chartDiv.style.width = "700px";
      chartDiv.style.height = "400px";
      document.getElementById("tv-chart").appendChild(chartDiv);

      new TradingView.widget({
        "container_id": "tradingview_chart",
        "width": 700,
        "height": 400,
        "symbol": symbol,
        "interval": "D",
        "timezone": "Europe/Istanbul",
        "theme": "light",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "hide_top_toolbar": false,
        "hide_legend": false,
        "save_image": false
      });
    }

    // ---- 3. YARIM DAİRE GAUGE, RENKLİ ve İĞNELİ ----
    // Kırmızı (0-33), Sarı (33-66), Yeşil (66-100)
    const gaugeNeedle = {
      id: 'needle',
      afterDatasetDraw(chart, args, options) {
        const value = chart.data.datasets[0].value;
        const angle = Math.PI * (1 - value/100);
        const cx = chart.getDatasetMeta(0).data[0].x;
        const cy = chart.getDatasetMeta(0).data[0].y;
        const r = chart.getDatasetMeta(0).data[0].outerRadius * 0.93;

        const ctx = chart.ctx;
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -r);
        ctx.lineWidth = 6;
        ctx.strokeStyle = "#222";
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0,0,9,0,2*Math.PI);
        ctx.fillStyle="#222";
        ctx.fill();
        ctx.restore();

        // Değer ortada
        ctx.save();
        ctx.font = 'bold 30px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = "#222";
        ctx.fillText(value+"%", cx, cy+54);
        ctx.font = '17px Arial';
        ctx.fillStyle = "#444";
        ctx.fillText("0%", cx-160, cy+63);
        ctx.fillText("50%", cx, cy-130);
        ctx.fillText("100%", cx+160, cy+63);
        ctx.restore();
      }
    };
    let gaugeChart;
    function drawGauge(val = 62) {
      if (gaugeChart) gaugeChart.destroy();
      let bg = [
        val <= 33 ? "#e74c3c" : "#eee",
        val > 33 && val <= 66 ? "#f7b731" : "#eee",
        val > 66 ? "#27ae60" : "#eee"
      ];
      // Gauge 3 renkli, kalan gri
      let data = [
        Math.min(val,33),
        Math.max(0, Math.min(val-33,33)),
        Math.max(0, Math.min(val-66,34)),
        100-val
      ];
      const ctx = document.getElementById('myGauge').getContext('2d');
      gaugeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ["Kırmızı", "Sarı", "Yeşil", "Boş"],
          datasets: [{
            data: data,
            value: val,
            backgroundColor: [bg[0], bg[1], bg[2], "#e0e0e0"],
            borderWidth: 0
          }]
        },
        options: {
          rotation: -Math.PI,
          circumference: Math.PI,
          cutout: "70%",
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        },
        plugins: [gaugeNeedle]
      });
    }

    // ---- 4. KAP HABERLERİ (fetch) ----
    async function fetchKapNews() {
      try {
        // Proxy ile CORS çözümü (deploy ortamında çalışır)
        const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.kap.org.tr/tr/rss/son-dakika-bildirimleri'));
        const data = await response.json();
        const parser = new DOMParser();
        const xml = parser.parseFromString(data.contents, "application/xml");
        const items = Array.from(xml.querySelectorAll('item')).slice(0, 12);
        let html = '';
        items.forEach(item => {
          const title = item.querySelector('title').textContent;
          const link = item.querySelector('link').textContent;
          html += `<div><a href="${link}" target="_blank">${title}</a></div>`;
        });
        document.getElementById('news-list').innerHTML = html;
      } catch (e) {
        document.getElementById('news-list').innerHTML = "KAP haberlerine erişilemiyor.";
      }
    }

    // --- İLK YÜKLEME
    loadSymbolWidget('bist');
    loadChart("BIST:XU100");
    drawGauge(62);
    fetchKapNews();

    // --- BUTONLARA GÖRE DEĞİŞTİR
    document.getElementById('bistBtn').onclick = () => {
      loadSymbolWidget('bist');
      loadChart("BIST:XU100");
      drawGauge(62);
      document.getElementById("gauge-label").innerText = "Endeks Gücü";
    };
    document.getElementById('usBtn').onclick = () => {
      loadSymbolWidget('nasdaq');
      loadChart("NASDAQ:NDX");
      drawGauge(81);
      document.getElementById("gauge-label").innerText = "NASDAQ Greed Meter";
    };
    document.getElementById('emtiaBtn').onclick = () => {
      loadSymbolWidget('emtia');
      loadChart("TVC:GOLD");
      drawGauge(49);
      document.getElementById("gauge-label").innerText = "Emtia Momentum";
    };
  </script>
</body>
</html>
