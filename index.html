<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Trion Strateji</title>
  <meta name="viewport" content="width=1100">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
    }
    header {
      font-size: 2em;
      font-weight: bold;
      margin: 20px 0 10px 40px;
    }
    .center-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .center-buttons button {
      font-size: 1em;
      padding: 9px 22px;
      border-radius: 8px;
      background: #f2f2f2;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: background .18s;
    }
    .center-buttons button:hover { background: #d3e5ff; }
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 32px;
      width: 100%;
      max-width: 1500px;
      margin: 0 auto;
    }
    .left, .right {
      width: 270px;
      min-height: 700px;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 10px #eee;
    }
    .middle {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .gauge-area {
      width: 340px;
      margin: 24px auto 0 auto;
      text-align: center;
      /* background: #f9f9f9; */
      border-radius: 18px;
      padding: 5px 0 18px 0;
    }
    .gauge-label {
      font-weight: bold;
      font-size: 1.13em;
      margin-bottom: 8px;
      color: #222;
    }
    .news-title { font-weight: bold; font-size: 1.12em; margin-bottom: 12px; margin-top: 5px; }
    .news-list { max-height: 680px; overflow-y: auto; font-size: 0.98em; line-height: 1.5; }
    .news-list a { color: #0a2885; text-decoration: none; }
    .news-list a:hover { text-decoration: underline; }
    @media (max-width: 1100px) {
      .container { flex-direction: column; align-items: stretch; }
      .left, .right, .middle { width: 100%; min-height: unset; }
      .gauge-area { width: 95vw; }
    }
    /* G A U G E */
    :root {
      --gray: #f9f9f9;
      --blue: rgb(0, 122, 253);
      --green: #27ae60;
      --yellow: #f7b731;
      --red: #e74c3c;
      --white: #fff;
    }
    .gauge {
      position: relative;
      width: 300px;
      height: 150px;
      margin: 0 auto;
    }
    .progress {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px solid #eee;
      border-bottom: none;
      border-radius: 300px 300px 0 0 / 150px 150px 0 0;
      background: conic-gradient(
        var(--red) 0 33%, 
        var(--yellow) 0 66%, 
        var(--green) 0 100%, 
        #e0e0e0 0 100%
      );
      overflow: hidden;
    }
    .progress::before {
      content: '';
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -45%);
      width: 78%;
      height: 78%;
      background: var(--white);
      border-radius: 50% 50% 0 0 / 70% 70% 0 0;
      z-index: 10;
    }
    .needle {
      position: absolute;
      left: 50%; bottom: 10px;
      width: 7px; height: 115px;
      background: #222;
      border-radius: 4px;
      transform: rotate(0deg);
      transform-origin: bottom center;
      z-index: 20;
      transition: transform 1.2s cubic-bezier(.4,2.1,.6,1);
    }
    .gauge-ticks {
      position: absolute; width: 100%; height: 100%; left: 0; top: 0; z-index: 19;
      pointer-events: none;
    }
    .gauge-ticks span {
      position: absolute;
      font-size: 13px;
      color: #666;
      user-select: none;
    }
    .gauge-ticks .t0 { left: -5px; bottom: 10px; }
    .gauge-ticks .t50 { left: 48%; top: -10px; transform: translateX(-50%); }
    .gauge-ticks .t100 { right: -7px; bottom: 10px; }
    .gauge-value {
      position: absolute; left: 50%; bottom: 0px; width: 90px; text-align: center;
      font-weight: bold; color: #222; font-size: 2em; transform: translateX(-50%);
      z-index: 30; background: #fff;
      border-radius: 9px; box-shadow: 0 2px 8px #eee;
      padding: 0 2px;
    }
  </style>
</head>
<body>
  <header>Trion Strateji</header>
  <div class="center-buttons">
    <button id="bistBtn">Borsa İstanbul</button>
    <button id="usBtn">Amerika B.</button>
    <button id="emtiaBtn">Emtialar</button>
  </div>
  <div class="container">
    <!-- SOLDA TradingView -->
    <div class="left">
      <div id="symbol-widget"></div>
    </div>
    <!-- ORTA GRAFİK VE GAUGE -->
    <div class="middle">
      <div id="tv-chart"></div>
      <div class="gauge-area">
        <div class="gauge-label" id="gauge-label">Endeks Gücü</div>
        <div class="gauge" id="gaugeBox">
          <div class="progress"></div>
          <div class="needle" id="needle"></div>
          <div class="gauge-ticks">
            <span class="t0">0%</span>
            <span class="t50">50%</span>
            <span class="t100">100%</span>
          </div>
          <div class="gauge-value" id="gauge-value">62</div>
        </div>
      </div>
    </div>
    <!-- SAĞDA HABERLER -->
    <div class="right">
      <div class="news-title">Finans Haberleri</div>
      <div class="news-list" id="news-list"></div>
    </div>
  </div>
  <!-- TradingView JS -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    // 1. SOLDA TradingView "Symbol Overview"
    const widgets = {
      bist: {
        symbols: [["BIST 100", "BIST:XU100"], ["BIST 30", "BIST:XU030"], ["THYAO", "BIST:THYAO"], ["ASELS", "BIST:ASELS"]],
      },
      nasdaq: {
        symbols: [["NASDAQ 100", "NASDAQ:NDX"], ["Apple", "NASDAQ:AAPL"], ["Microsoft", "NASDAQ:MSFT"], ["Nvidia", "NASDAQ:NVDA"]],
      },
      emtia: {
        symbols: [["Altın", "TVC:GOLD"], ["Platin", "TVC:PLATINUM"], ["BTC/USD", "BINANCE:BTCUSDT"]],
      }
    };
    function loadSymbolWidget(type) {
      document.getElementById("symbol-widget").innerHTML = "";
      let script = document.createElement('script');
      script.type = "text/javascript";
      script.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
      script.async = true;
      script.innerHTML = JSON.stringify({
        symbols: widgets[type].symbols,
        width: "100%",
        height: "510",
        locale: "tr",
        colorTheme: "light",
        isTransparent: false,
        showVolume: true,
        showChart: true
      });
      document.getElementById("symbol-widget").appendChild(script);
    }

    // 2. Orta TradingView Ana Grafik
    function loadChart(symbol) {
      document.getElementById("tv-chart").innerHTML = "";
      let chartDiv = document.createElement('div');
      chartDiv.id = "tradingview_chart";
      chartDiv.style.width = "700px";
      chartDiv.style.height = "400px";
      document.getElementById("tv-chart").appendChild(chartDiv);

      new TradingView.widget({
        "container_id": "tradingview_chart",
        "width": 700,
        "height": 400,
        "symbol": symbol,
        "interval": "D",
        "timezone": "Europe/Istanbul",
        "theme": "light",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "hide_top_toolbar": false,
        "hide_legend": false,
        "save_image": false
      });
    }

    // 3. G A U G E 
    function setGauge(val) {
      // 0-100 arasında bir değer (ör: 62)
      val = Math.max(0, Math.min(100, val));
      const needle = document.getElementById('needle');
      const valueBox = document.getElementById('gauge-value');
      // 0%= -90 derece, 100%= +90 derece
      const angle = (val / 100) * 180 - 90;
      needle.style.transform = `rotate(${angle}deg)`;
      valueBox.innerText = val;
      valueBox.style.color = val < 33 ? "#e74c3c" : (val < 66 ? "#f7b731" : "#27ae60");
    }

    // 4. KAP HABERLERİ
    async function fetchKapNews() {
      try {
        // Proxy ile CORS çözümü (deploy ortamında çalışır)
        const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.kap.org.tr/tr/rss/son-dakika-bildirimleri'));
        const data = await response.json();
        const parser = new DOMParser();
        const xml = parser.parseFromString(data.contents, "application/xml");
        const items = Array.from(xml.querySelectorAll('item')).slice(0, 12);
        let html = '';
        items.forEach(item => {
          const title = item.querySelector('title').textContent;
          const link = item.querySelector('link').textContent;
          html += `<div><a href="${link}" target="_blank">${title}</a></div>`;
        });
        document.getElementById('news-list').innerHTML = html;
      } catch (e) {
        document.getElementById('news-list').innerHTML = "KAP haberlerine erişilemiyor.";
      }
    }

    // İlk yükleme
    loadSymbolWidget('bist');
    loadChart("BIST:XU100");
    setGauge(62);
    fetchKapNews();

    // Butonlarla dinamik değişim
    document.getElementById('bistBtn').onclick = () => {
      loadSymbolWidget('bist');
      loadChart("BIST:XU100");
      setGauge(62);
      document.getElementById("gauge-label").innerText = "Endeks Gücü";
    };
    document.getElementById('usBtn').onclick = () => {
      loadSymbolWidget('nasdaq');
      loadChart("NASDAQ:NDX");
      setGauge(81);
      document.getElementById("gauge-label").innerText = "NASDAQ Greed Meter";
    };
    document.getElementById('emtiaBtn').onclick = () => {
      loadSymbolWidget('emtia');
      loadChart("TVC:GOLD");
      setGauge(49);
      document.getElementById("gauge-label").innerText = "Emtia Momentum";
    };
  </script>
</body>
</html>
